<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Raymarching">
<meta itemprop="description" content="I always was very interested into fractals, notably I played quite a fair bit with Apophysis. That&rsquo;s how I created these images:
As you can see, there was also transparency. They look very different on a white or on a black background, you can try (for the first two ones)
So it was really nice, but I had no idea how to render fractals. And I didn&rsquo;t care.
Now the time has come.">


<meta itemprop="datePublished" content="2019-08-27T00:20:57&#43;02:00" />
<meta itemprop="dateModified" content="2019-08-27T00:20:57&#43;02:00" />
<meta itemprop="wordCount" content="744">



<meta itemprop="keywords" content="research,code,python,rendering," />
<meta property="og:title" content="Raymarching" />
<meta property="og:description" content="I always was very interested into fractals, notably I played quite a fair bit with Apophysis. That&rsquo;s how I created these images:
As you can see, there was also transparency. They look very different on a white or on a black background, you can try (for the first two ones)
So it was really nice, but I had no idea how to render fractals. And I didn&rsquo;t care.
Now the time has come." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://luvideria.github.io/EnterTheExit/posts/raymarching/" />
<meta property="article:published_time" content="2019-08-27T00:20:57+02:00" />
<meta property="article:modified_time" content="2019-08-27T00:20:57+02:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Raymarching"/>
<meta name="twitter:description" content="I always was very interested into fractals, notably I played quite a fair bit with Apophysis. That&rsquo;s how I created these images:
As you can see, there was also transparency. They look very different on a white or on a black background, you can try (for the first two ones)
So it was really nice, but I had no idea how to render fractals. And I didn&rsquo;t care.
Now the time has come."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/EnterTheExit/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/EnterTheExit/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/EnterTheExit/favicon-16x16.png">
	<link rel="manifest" href="/EnterTheExit/site.webmanifest">
	<link rel="mask-icon" href="/EnterTheExit/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/EnterTheExit/favicon.ico">

	<title>Raymarching</title>
	<link rel="stylesheet" href="https://luvideria.github.io/EnterTheExit/css/style.min.854f0848deed4acb197a6a4caf04c3aea9749a6874d546a9d273d457d74f236d.css" integrity="sha256-hU8ISN7tSssZempMrwTDrql0mmh01Uap0nPUV9dPI20=" crossorigin="anonymous">
	

</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp faster">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://luvideria.github.io/EnterTheExit">Enter The Exit</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://luvideria.github.io/EnterTheExit/posts/">Free yourself</a>
				<a href="https://luvideria.github.io/EnterTheExit/about">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<button id="toc-btn" class="hdr-btn desktop-only-ib" title="Table of Contents"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3" y2="6"></line><line x1="3" y1="12" x2="3" y2="12"></line><line x1="3" y1="18" x2="3" y2="18"></line></svg></button><button id="menu-btn" class="hdr-btn" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://luvideria.github.io/EnterTheExit/posts/">Free yourself</a></li>
			<li><a href="https://luvideria.github.io/EnterTheExit/about">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Aug 27, 2019</span></div>
				<h1>Raymarching</h1>
			</header>
			<div class="content">
				<p>I always was very interested into fractals, notably I played quite a fair bit with <a href="https://en.wikipedia.org/wiki/Apophysis_(software)">Apophysis</a>. That&rsquo;s how I created these images:</p>

<p><img src="https://i.ibb.co/DRx1nmv/Grand-Julian.png" alt="Grand-Julian" /></p>

<p><img src="https://i.ibb.co/Fgt4nWm/Piatch.png" alt="Piatch" /></p>

<p><img src="https://i.ibb.co/th66ZGb/triancore.png" alt="triancore" /></p>

<p><img src="https://i.ibb.co/qgdm7br/Triangula.png" alt="Triangula" /></p>

<p>As you can see, there was also transparency. They look very different on a white or on a black background, you can try (for the first two ones)</p>

<p>So it was really nice, but I had no idea how to render fractals. And I didn&rsquo;t care.</p>

<p>Now the time has come. I&rsquo;ve already written my own (crappy) pathtracer so it cannot be so hard.
I understand how raytracing works. But I never had the chance to learn about ray marching.</p>

<p>So I fiddled with python and found some ressources on internet (where else ?)
I wanted to have as few info as possible, and I wanted to solve all the problems myself.</p>

<p>Guess what?
It&rsquo;s easy.
I&rsquo;m not joking:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="c1">#this is the object list</span>
<span class="n">o</span><span class="o">=</span><span class="nb">list</span><span class="p">()</span>
<span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sphere</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">0.2</span><span class="p">]))</span>
<span class="n">o</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Sphere</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">],</span><span class="n">c</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.7</span><span class="p">]))</span>
<span class="c1">#setting camera parameters, first position, then point to look at</span>
<span class="n">c</span><span class="o">=</span><span class="n">Camera</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">15</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">fovy</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span><span class="n">xres</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span><span class="n">yres</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">img</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">xres</span><span class="p">,</span><span class="n">yres</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span> <span class="c1"># 3channels</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">xres</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">yres</span><span class="p">):</span>
        <span class="nb">dir</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">getDirPix</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
        <span class="n">cpos</span><span class="o">=</span><span class="n">c</span><span class="o">.</span><span class="n">pos</span>
        <span class="c1">#index, final pos of the ray</span>
        <span class="n">io</span><span class="p">,</span><span class="n">sp</span><span class="o">=</span><span class="n">rayMarch</span><span class="p">(</span><span class="n">cpos</span><span class="p">,</span><span class="nb">dir</span><span class="p">,</span><span class="n">o</span><span class="p">)</span>
        <span class="n">contrib</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span>
        <span class="k">if</span> <span class="n">io</span><span class="o">==-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">contrib</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">contrib</span><span class="o">=</span><span class="n">o</span><span class="p">[</span><span class="n">io</span><span class="p">]</span><span class="o">.</span><span class="n">c</span><span class="p">(</span><span class="n">cpos</span><span class="p">,</span><span class="nb">dir</span><span class="p">)</span>
        <span class="n">img</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">=</span><span class="n">contrib</span></code></pre></div>
<p>Of course there are the <code>rayMarch()</code> function and the <code>Camera</code>.</p>

<p>Basically only two things differ from normal ray tracing:</p>

<ul>
<li>intersection function does not really exist anymore</li>
<li>objects are represented by a signed distance function</li>
<li>your ray is litterally taking small steps to go traverse the scene</li>
</ul>

<p>The process goes this way:</p>

<ul>
<li>define objects (like spheres) with SDF corresponding to their parameters (radius, position, color)</li>
<li>choose an origin $O_r$ for your ray (like, not too far not too close)</li>
<li>choose a direction $d$ for your ray (straight on a sphere is good)</li>
</ul>

<p>Here, Rey Marching begins</p>

<ol>
<li>then compute the $SDF(O_r)$ for all objects in your scene</li>
<li>take the minimum of it, let&rsquo;s call it <del>Oscar</del> $msdf$</li>
<li>advance your ray of $msdf$ in the direction d (so it is $newO_r=O_r+msdf+epsilon$)

<ul>
<li>don&rsquo;t forget to add an epsilon, so that you are sure you are inside the sphere and the function change its sign</li>
<li>actually I don&rsquo;t really know if it&rsquo;s good practice in this algorithm, but that&rsquo;s what we do in ray tracing (to prevent self intersection)</li>
</ul></li>
<li>then you repeat using the $newO_r$</li>
<li>check if the sdf is 0 or less, if it&rsquo;s the case then you intersected, report the color value</li>
</ol>

<p>If you do that, you will loop indefinetely so best thing is to impose a hard limit to the distance the ray can travel
Another solution would be to compute the bouding box of the scene (if at all, possible) and to measure the distance from the ray to the farthest point of it. But well, I just use 50, it&rsquo;s a good number.</p>

<p>You can also impose a number of maximum steps, and if the ray is misbehaving, (doing too many small steps) hop, background color</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">EPSILON</span><span class="o">=</span><span class="mf">1e-8</span>
<span class="n">LIM</span><span class="o">=</span><span class="mi">256</span>
<span class="n">END</span><span class="o">=</span><span class="mi">50</span>
<span class="k">def</span> <span class="nf">rayMarch</span><span class="p">(</span><span class="n">sp</span><span class="p">,</span><span class="n">sd</span><span class="p">,</span><span class="n">o</span><span class="p">:</span><span class="nb">list</span><span class="p">()):</span>
    <span class="s1">&#39;&#39;&#39; sp is starting point, sd is starting direction and o is the list of shapes
</span><span class="s1">    marches in the scene, returns
</span><span class="s1">    * index of Shape intersected
</span><span class="s1">    * last position of ray
</span><span class="s1">    &#39;&#39;&#39;</span>
    <span class="n">minlist</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">o</span><span class="p">]</span>
    <span class="n">v</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">minlist</span><span class="p">)</span>
    <span class="n">index</span><span class="o">=</span><span class="n">minlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">depth</span><span class="o">=</span><span class="n">v</span>
    <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">while</span> <span class="n">v</span><span class="o">&gt;</span><span class="n">EPSILON</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">LIM</span><span class="p">:</span>
        <span class="n">minlist</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">d</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">o</span><span class="p">]</span>
        <span class="n">v</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">minlist</span><span class="p">)</span>
        <span class="n">index</span><span class="o">=</span><span class="n">minlist</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        
        <span class="c1"># epsilon so that we are sure to be inside</span>
        <span class="n">sp</span><span class="o">=</span><span class="n">sp</span><span class="o">+</span><span class="n">v</span><span class="o">*</span><span class="n">sd</span><span class="o">+</span><span class="n">EPSILON</span>
        <span class="n">i</span><span class="o">+=</span><span class="mi">1</span>
        <span class="c1"># yes I know i compute twice the same stuff,</span>
        <span class="c1"># I added this later and I was too lazy to change the rest </span>
        <span class="n">depth</span><span class="o">+=</span><span class="n">v</span><span class="o">+</span><span class="n">EPSILON</span>
        <span class="k">if</span> <span class="n">depth</span><span class="o">&gt;</span><span class="n">END</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">sp</span>
    <span class="k">if</span> <span class="n">i</span><span class="o">&gt;=</span><span class="n">LIM</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">sp</span>
    <span class="k">return</span> <span class="n">index</span><span class="p">,</span><span class="n">sp</span></code></pre></div>
<p>Now, you say, that does not make an image!
Of course we need a camera. But that&rsquo;s maths and all, so let me just say that you give the camera a position to be, a position to look at, and boom, you&rsquo;re set.</p>

<p>Now that we have a camera, we call the very convenient function <code>getPixelDir(i,j)</code> that gives us the direction or the ray</p>

<p>Let&rsquo;s say we want a 1080p image, our image is $w=1920$ pixels wide and $h=1080$ pixels high</p>

<ul>
<li>loop $w$ times:

<ul>
<li>loop $h$ times:</li>
<li>$d=getPixelDir(i,j)$ ($i$,$j$ are the current loop number for $w$ and $h$ loops)</li>
<li>$p=getCameraPos$</li>
<li>$color=rayMarch(p,d)$</li>
<li>$img[i,j]=color$</li>
</ul></li>
</ul>

<p>boom done. Do that and, like me, you obtain THIS:</p>

<p><img src="https://i.ibb.co/nkQskTc/first.png" alt="img" /></p>

<p>Incredible huh?</p>

<p>Yes, it&rsquo;s shit, but what did you expect? there is no lighting, no bounce of the light. All this is for a real renderer.</p>

<p>I just wanted to see how it works but now, I need to get on the fractal train.</p>

<p>And I have to say, python sucks! It&rsquo;s so damn slow!</p>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://luvideria.github.io/EnterTheExit/tags/research">research</a></span><span class="tag"><a href="https://luvideria.github.io/EnterTheExit/tags/code">code</a></span><span class="tag"><a href="https://luvideria.github.io/EnterTheExit/tags/python">python</a></span><span class="tag"><a href="https://luvideria.github.io/EnterTheExit/tags/rendering">rendering</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>744 Words</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-08-27 00:20 &#43;0200</p>
			</footer>
		</article>
		<aside id="toc">
			<div class="toc-title">Table of Contents</div>
			
		</aside>
		<div class="post-nav thin">
			<a class="prev-post" href="https://luvideria.github.io/EnterTheExit/posts/my-tiny-dragon/">
				<span class="post-nav-label">Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>My Tiny Dragon</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>


	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2019 <a href="https://luvideria.github.io/EnterTheExit">John Doe</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://luvideria.github.io/EnterTheExit/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
	</script>
	<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
		  tex2jax: {
			inlineMath: [['$','$'], ['\\(','\\)']],
			displayMath: [['$$','$$'], ['\[','\]']],
			processEscapes: true,
			processEnvironments: true,
			skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
			TeX: { equationNumbers: { autoNumber: "AMS" },
				 extensions: ["AMSmath.js", "AMSsymbols.js"] }
		  }
		});
		</script>
		
		<script type="text/x-mathjax-config">
			MathJax.Hub.Queue(function() {
			  // Fix <code> tags after MathJax finishes running. This is a
			  // hack to overcome a shortcoming of Markdown. Discussion at
			  // https://github.com/mojombo/jekyll/issues/199
			  var all = MathJax.Hub.getAllJax(), i;
			  for(i = 0; all.length >i ; i += 1) {
				  all[i].SourceElement().parentNode.className += ' has-jax';
			  }
		  });
		  </script>


	<script src="https://luvideria.github.io/EnterTheExit/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	

</body>

</html>
